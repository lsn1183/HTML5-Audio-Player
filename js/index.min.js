$(function(){function C(){var e=(a.width(),a.height()),g=e-c.opts.height;d.height(g),p.height(g-f.opts.height)}function D(){return $.ajax({url:B.getListUrl,dataType:"json"})}function E(a){return $.ajax({url:a})}function F(){var a="",b=B.songList.slice(0),c=[];B.songList.forEach(function(d,e){var f=b.splice(Math.floor(Math.random()*b.length),1)[0];a+='<li data-id="'+e+'">'+'<a title="'+f.title+"-"+f.artist+'">'+'<span class="title">'+f.title+"</span>"+" - "+'<span class="artist">'+f.artist+"</span>"+"</a>"+"</li>",c.push(f)}),B.songList=c,q.html(a)}function G(){try{var a=this.buffered,b=this.duration,d=(a.start(0),a.end(0)),e=100*(d/b);B.songList[B.currentID].duration||I(),s.width(e+"%"),100==e&&B.$audio.off("progress",G)}catch(f){}}function H(){var a=B.songList[B.currentID];l.html(a.title).attr("title",a.title),m.html(a.artist).attr("title",a.artist),k.attr("src",a.cover||B.defaultArtist),I()}function I(){var d,e,f,a=B.songList[B.currentID],b=a.duration,c="";if(!b){if(isNaN(B.audio.duration))return o.html("00:00"),!1;b=a.duration=Math.ceil(B.audio.duration)}f=String(b).match(/(\d*)([:：]?)(\d*)/),f?(""!=f[2]?(d=J(f[1]),e=J(f[3])):(d=J(parseInt(Number(f[1])/60)),e=J(Math.ceil(Number(f[1])%60))),c=d+":"+e):c="00:00",a.totalTimes=60*d+Number(e),o.html(c)}function J(a,b){return b=b||2,Number(a)<Math.pow(10,b-1)?"0"+Number(a):a}function K(a,b,c){return b=b||2,c?Number(a).toFixed(b):Number(Number(a).toFixed(b))}function L(){var a,b,c,d,e,f,g;if(B.audio.currentTime>=B.audio.duration)return N(),!1;if(B.audio.paused)return!1;if(a=B.songList[B.currentID],b=B.audio.currentTime,c=1e3*b,a.totalTimes?(d=K(100*(B.audio.currentTime/a.totalTimes)),t.width(d+"%")):(o.html("00:00"),t.width(0)),a.lrcFormat&&a.lrcFormat.ajax)for(e=0,f=a.lrcFormat.lrc.list,g=f.length;g>e;e++)if(c>=f[e].time&&(e==g-1||c<f[e+1].time)){if(a.lrcFormat.currentID===e)break;a.lrcFormat.currentID=e,e>5?v.css("margin-top",-30*(e-5)+"px"):v.css("margin-top",0),v.find('li[data-id="'+e+'"]').addClass("current").siblings().removeClass("current");break}n.html(J(parseInt(Number(B.audio.currentTime)/60))+":"+J(Math.ceil(Number(B.audio.currentTime)%60))),requestAnimationFrame(L)}function M(){cancelAnimationFrame(B.songPlaying),B.songPlaying=requestAnimationFrame(L)}function N(){B.audio.stop=!0,cancelAnimationFrame(B.songPlaying),v.css("margin-top",0),P(!0),j.removeClass("anim-pause anim-rotate"),t.width(0),n.html("00:00"),V()}function O(a){if(a!==B.history[B.history.length-1]&&B.history.push(a),B.audio.stop=!1,B.audio.src=B.songList[a].media,B.$audio.off("progress",G),B.$audio.on("progress",G),j.addClass("anim-rotate"),setTimeout(function(){j.removeClass("anim-pause")},1e3),H(B.currentID=a),P(),M(),B.songList[a].lrcFormat)v.html(B.songList[a].lrcFormat.html);else{if(!B.songList[a].lrc)return B.songList[a].lrcFormat={list:["暂无歌词"],html:'<li class="lrc_noLrc">暂无歌词。。。</li>'},v.html(B.songList[a].lrcFormat.html),!1;E(B.songList[a].lrc).done(function(b){B.songList[a].lrcFormat=R(b),v.html(B.songList[a].lrcFormat.html)})}}function P(a){if(-1===B.currentID)return!1;if(B.audio.paused&&a!==!0){if(B.audio.stop)return O(B.currentID),!1;j.removeClass("anim-pause"),B.audio.play(),h.removeClass("icon_play").addClass("icon_pause"),B.songPlaying=requestAnimationFrame(L)}else j.addClass("anim-pause"),B.audio.pause(),h.removeClass("icon_pause").addClass("icon_play"),cancelAnimationFrame(B.songPlaying)}function R(a){var d,b={list:[]},c=a.split("\n");return c.forEach(function(a){var e,f,g;(d=a.match(Q.ti))?b.ti=d[1]:(d=a.match(Q.ar))?b.ar=d[1]:(d=a.match(Q.al))?b.al=d[1]:(d=a.match(Q.by))?b.by=d[1]:(d=a.match(Q.offset))?b.offset=d[1]:(d=a.match(Q.rowLyric))&&(e=d[3],f=d[1],g=f.match(Q.times),g.forEach(function(a){var d=a.match(Q.time);b.list.push({timeTag:a,m:d[1],s:d[2],ms:d[3],time:1e3*60*d[1]+1e3*d[2]+10*d[3]+(parseInt(b.offset)||0),lrc:e})}))}),b.list.sort(function(a,b){return a.time-b.time}),{ajax:a,lrc:b,html:S(b)}}function S(a){var b="";return a.ti&&(b+='<li class="lrc_ti">歌曲名：'+a.ti+"</li>"),a.ar&&(b+='<li class="lrc_ar">歌手名：'+a.ar+"</li>"),a.al&&(b+='<li class="lrc_al">专辑名：'+a.al+"</li>"),a.by&&(b+='<li class="lrc_by">制作者：'+a.by+"</li>"),a.list.forEach(function(a,c){b+=0===c?'<li class="lrc_first" data-id="'+c+'" data-time="'+a.time+'">'+a.lrc+"</li>":'<li data-id="'+c+'" data-time="'+a.time+'">'+a.lrc+"</li>"}),b}function T(a){if(-1===B.currentID||!B.audio.duration)return!1;var b=a.offsetX,c=B.audio.duration*b/r.opts.width;B.audio.currentTime=c}function U(){B.history.length>1?O(B.currentID=B.history[B.history.length-2]):O(B.currentID=B.songList.length-1),q.find("li").eq(B.currentID).addClass("current").siblings().removeClass("current")}function V(){switch(P(!0),B.config.playType){case"one":O(B.currentID);break;case"list":(-1===B.currentID||++B.currentID>=B.songList.length)&&(B.currentID=0),O(B.currentID);break;case"random":O(Math.floor(Math.random()*B.songList.length))}q.find("li").eq(B.currentID).addClass("current").siblings().removeClass("current")}function W(){B.bg.inited||(A.html(X()).on("click","li",function(){var a=$(this),c=a.data("id");a.addClass("current").siblings().removeClass("current"),b.css("background-image","url("+B.bg.list[B.bg.id=c]+")"),localStorage.setItem("bgId",c)}),A.find("li").eq(B.bg.id).addClass("current")),x.toggleClass("current")}function X(){var a="";return B.bg.list.forEach(function(b,c){a+='<li data-id="'+c+'"><a><img src="'+b+'"/></a></li>'}),a}var Q,a=$(window),b=$("body"),c=$(".header"),d=$(".main"),f=($("#playBox"),$(".songInfo")),g=$("#songPrev"),h=$("#songPlay"),i=$("#songNext"),j=f.find(".songCover_box a"),k=f.find(".songCover_box img"),l=f.find(".songTitle"),m=f.find(".songArtist"),n=f.find(".currentTime"),o=f.find(".totalTime"),p=$(".songList"),q=p.find("ul"),r=$(".songProgress"),s=$(".loadProgress"),t=$(".currentProgress"),u=$(".lrc"),v=u.find("ul"),w=$(".playConfig"),x=$(".bgConfig"),y=$("#bgChangeBtn"),A=($(".bgList"),$(".bgList>ul")),B={songList:[],config:{playType:localStorage.getItem("playType")||"list"},audio:new Audio,currentID:-1,songPlaying:null,defaultArtist:"img/defaultArtist.jpg",getListUrl:"mp3.json",history:[],bg:{inited:!1,id:localStorage.getItem("bgId")||2,list:["http://www.dongting.com/styles/images/bg/large/001.jpg","http://www.dongting.com/styles/images/bg/large/002.jpg","http://www.dongting.com/styles/images/bg/large/003.jpg","http://www.dongting.com/styles/images/bg/large/004.jpg","http://www.dongting.com/styles/images/bg/large/005.jpg","http://www.dongting.com/styles/images/bg/large/006.jpg","http://www.dongting.com/styles/images/bg/large/007.jpg","http://www.dongting.com/styles/images/bg/large/008.jpg","http://www.dongting.com/styles/images/bg/large/009.jpg"]}};window.player=B,B.$audio=$(B.audio),c.opts={height:52},f.opts={height:150},r.opts={width:r.width()},C(),Q={ti:/\[ti[:：](.*)\]/,ar:/\[ar[:：](.*)\]/,al:/\[al[:：](.*)\]/,by:/\[by[:：](.*)\]/,offset:/\[offset[:：](-?\d*)\]/,rowLyric:/((\[\d+[:：]\d+[\.:：]?\d*\])+)(.*)/,times:/\[\d+[:：]\d+[\.:：]?\d*\]/g,time:/\[(\d+)[:：](\d+)[\.:：]?(\d*)\]/},w.find(".playConfig_"+B.config.playType).addClass("current"),b.css("background-image","url("+B.bg.list[B.bg.id]+")"),window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,D().done(function(a){B.songList=a.list}).then(F),a.on("resize",C),p.on("click","li",function(){var a=$(this),b=a.data("id");P(!0),a.addClass("current").siblings().removeClass("current"),O(b)}),v.on("click","li",function(){var a=$(this),b=a.data("time");return B.audio.paused||void 0===b?!1:(B.audio.stop&&O(B.currentID),B.audio.currentTime=b/1e3,void 0)}),w.on("click","a",function(){var a=$(this),b=a.data("type");localStorage.setItem("playType",B.config.playType=b),a.addClass("current").siblings().removeClass("current")}),$(document).on("keydown",function(a){var b;switch(a.which){case 13:B.audio.currentTime=0,a.preventDefault();break;case 32:P(),a.preventDefault();break;case 37:U(),a.preventDefault();break;case 39:V(),a.preventDefault();break;case 38:b=B.audio.volume+.1,b>1&&(b=1),B.audio.volume=b,a.preventDefault();break;case 40:b=B.audio.volume-.1,0>b&&(b=0),B.audio.volume=b,a.preventDefault()}}).on("click",function(){x.removeClass("current")}),x.on("click",function(a){a.stopPropagation()}),j.on("click",P),h.on("click",P),r.on("click",T),g.on("click",U),i.on("click",V),y.on("click",W),"function"==typeof define&&define.amd&&define("player",[],function(){return B})});