$(function(){var t=$(window),i=$("body"),e=$(".header"),a=$(".main"),r=$("#playBox"),n=$(".songInfo"),s=$("#songPrev"),o=$("#songPlay"),l=$("#songNext"),c=n.find(".songCover_box a"),u=n.find(".songCover_box img"),d=n.find(".songTitle"),g=n.find(".songArtist"),m=n.find(".currentTime"),f=n.find(".totalTime"),h=$(".songList"),p=h.find("ul"),b=$(".songProgress"),w=$(".loadProgress"),y=$(".currentProgress"),v=$(".lrc"),C=v.find("ul"),I=$(".playConfig"),L=$(".bgConfig"),k=$("#bgChangeBtn"),D=$(".bgList"),F=$(".bgList>ul");var T={songList:[],config:{playType:localStorage.getItem("playType")||"list"},audio:new Audio,currentID:-1,songPlaying:null,defaultArtist:"img/defaultArtist.jpg",getListUrl:"mp3.json",history:[],bg:{inited:false,id:localStorage.getItem("bgId")||2,list:["http://www.dongting.com/styles/images/bg/large/001.jpg","http://www.dongting.com/styles/images/bg/large/002.jpg","http://www.dongting.com/styles/images/bg/large/003.jpg","http://www.dongting.com/styles/images/bg/large/004.jpg","http://www.dongting.com/styles/images/bg/large/005.jpg","http://www.dongting.com/styles/images/bg/large/006.jpg","http://www.dongting.com/styles/images/bg/large/007.jpg","http://www.dongting.com/styles/images/bg/large/008.jpg","http://www.dongting.com/styles/images/bg/large/009.jpg"]}};window.player=T;T.$audio=$(T.audio);e.opts={height:52};n.opts={height:150};b.opts={width:b.width()};function j(){var i=t.width(),r=t.height(),s=r-e.opts.height;a.height(s);h.height(s-n.opts.height)}j();function A(){return $.ajax({url:T.getListUrl,dataType:"json"})}function N(t){return $.ajax({url:t})}function _(){var t="",i=T.songList.slice(0),e=[];T.songList.forEach(function(a,r){var n=i.splice(Math.floor(Math.random()*i.length),1)[0];t+='<li data-id="'+r+'">'+'<a title="'+n.title+"-"+n.artist+'">'+'<span class="title">'+n.title+"</span>"+" - "+'<span class="artist">'+n.artist+"</span>"+"</a>"+"</li>";e.push(n)});T.songList=e;p.html(t)}function P(){try{var t=this.buffered,i=this.duration,e=t.start(0),a=t.end(0),r=a/i*100;if(!T.songList[T.currentID].duration){x()}w.width(r+"%");if(r==100){T.$audio.off("progress",P)}}catch(n){}}function q(){var t=T.songList[T.currentID];d.html(t.title).attr("title",t.title);g.html(t.artist).attr("title",t.artist);u.attr("src",t.cover||T.defaultArtist);x()}function x(){var t=T.songList[T.currentID],i=t.duration,e="",a,r;if(!i){if(isNaN(T.audio.duration)){f.html("00:00");return false}else{i=t.duration=Math.ceil(T.audio.duration)}}var n=String(i).match(/(\d*)([:：]?)(\d*)/);if(!n){e="00:00"}else{if(n[2]!=""){a=M(n[1]);r=M(n[3])}else{a=M(parseInt(Number(n[1])/60));r=M(Math.ceil(Number(n[1])%60))}e=a+":"+r}t.totalTimes=a*60+Number(r);f.html(e)}function M(t,i){i=i||2;if(Number(t)<Math.pow(10,i-1)){return"0"+Number(t)}else{return t}}function E(t,i,e){i=i||2;if(e){return Number(t).toFixed(i)}else{return Number(Number(t).toFixed(i))}}function S(){if(T.audio.currentTime>=T.audio.duration){z();return false}if(T.audio.paused){return false}var t=T.songList[T.currentID],i=T.audio.currentTime,e=i*1e3;if(!t.totalTimes){f.html("00:00");y.width(0)}else{var a=E(T.audio.currentTime/t.totalTimes*100);y.width(a+"%")}if(t.lrcFormat&&t.lrcFormat.ajax){for(var r=0,n=t.lrcFormat.lrc.list,s=n.length;r<s;r++){if(e>=n[r].time&&(r==s-1||e<n[r+1].time)){if(t.lrcFormat.currentID===r){break}t.lrcFormat.currentID=r;if(r>5){C.css("margin-top",-30*(r-5)+"px")}else{C.css("margin-top",0)}C.find('li[data-id="'+r+'"]').addClass("current").siblings().removeClass("current");break}}}m.html(M(parseInt(Number(T.audio.currentTime)/60))+":"+M(Math.ceil(Number(T.audio.currentTime)%60)));requestAnimationFrame(S)}function R(){cancelAnimationFrame(T.songPlaying);T.songPlaying=requestAnimationFrame(S)}function z(){T.audio.stop=true;cancelAnimationFrame(T.songPlaying);C.css("margin-top",0);U(true);c.removeClass("anim-pause anim-rotate");y.width(0);m.html("00:00");O()}function B(t){if(t!==T.history[T.history.length-1]){T.history.push(t)}T.audio.stop=false;T.audio.src=T.songList[t].media;T.$audio.off("progress",P);T.$audio.on("progress",P);c.addClass("anim-rotate");C.css("margin-top",0);setTimeout(function(){c.removeClass("anim-pause")},1e3);q(T.currentID=t);U();R();if(T.songList[t].lrcFormat){C.html(T.songList[t].lrcFormat.html)}else{if(!T.songList[t].lrc){T.songList[t].lrcFormat={list:["暂无歌词"],html:'<li class="lrc_noLrc">暂无歌词。。。</li>'};C.html(T.songList[t].lrcFormat.html);return false}N(T.songList[t].lrc).done(function(i){T.songList[t].lrcFormat=G(i);C.html(T.songList[t].lrcFormat.html)})}}function U(t){if(T.currentID===-1){return false}if(!T.audio.paused||t===true){c.addClass("anim-pause");T.audio.pause();o.removeClass("icon_pause").addClass("icon_play");cancelAnimationFrame(T.songPlaying)}else{if(T.audio.stop){B(T.currentID);return false}c.removeClass("anim-pause");T.audio.play();o.removeClass("icon_play").addClass("icon_pause");T.songPlaying=requestAnimationFrame(S)}}var X={ti:/\[ti[:：](.*)\]/,ar:/\[ar[:：](.*)\]/,al:/\[al[:：](.*)\]/,by:/\[by[:：](.*)\]/,offset:/\[offset[:：](-?\d*)\]/,rowLyric:/((\[\d+[:：]\d+[\.:：]?\d*\])+)(.*)/,times:/\[\d+[:：]\d+[\.:：]?\d*\]/g,time:/\[(\d+)[:：](\d+)[\.:：]?(\d*)\]/};function G(t){var i={list:[]};var e=t.split("\n");var a;e.forEach(function(t,e){if(a=t.match(X.ti)){i.ti=a[1]}else if(a=t.match(X.ar)){i.ar=a[1]}else if(a=t.match(X.al)){i.al=a[1]}else if(a=t.match(X.by)){i.by=a[1]}else if(a=t.match(X.offset)){i.offset=a[1]}else if(a=t.match(X.rowLyric)){var r=a[3];var n=a[1];var s=n.match(X.times);s.forEach(function(t,e){var a=t.match(X.time);i.list.push({timeTag:t,m:a[1],s:a[2],ms:a[3],time:a[1]*60*1e3+a[2]*1e3+a[3]*10+(parseInt(i.offset)||0),lrc:r})})}});i.list.sort(function(t,i){return t.time-i.time});return{ajax:t,lrc:i,html:H(i)}}function H(t){var i="";if(t.ti){i+='<li class="lrc_ti">歌曲名：'+t.ti+"</li>"}if(t.ar){i+='<li class="lrc_ar">歌手名：'+t.ar+"</li>"}if(t.al){i+='<li class="lrc_al">专辑名：'+t.al+"</li>"}if(t.by){i+='<li class="lrc_by">制作者：'+t.by+"</li>"}t.list.forEach(function(t,e){if(e===0){i+='<li class="lrc_first" data-id="'+e+'" data-time="'+t.time+'">'+t.lrc+"</li>"}else{i+='<li data-id="'+e+'" data-time="'+t.time+'">'+t.lrc+"</li>"}});return i}function J(t){if(T.currentID===-1||!T.audio.duration){return false}var i=t.offsetX,e=T.audio.duration*i/b.opts.width;T.audio.currentTime=e}function K(){if(T.history.length>1){B(T.currentID=T.history[T.history.length-2])}else{B(T.currentID=T.songList.length-1)}p.find("li").eq(T.currentID).addClass("current").siblings().removeClass("current")}function O(){U(true);switch(T.config.playType){case"one":B(T.currentID);break;case"list":if(T.currentID===-1||++T.currentID>=T.songList.length){T.currentID=0}B(T.currentID);break;case"random":B(Math.floor(Math.random()*T.songList.length));break}p.find("li").eq(T.currentID).addClass("current").siblings().removeClass("current")}function Q(){if(!T.bg.inited){F.html(V()).on("click","li",function(){var t=$(this),e=t.data("id");t.addClass("current").siblings().removeClass("current");i.css("background-image","url("+T.bg.list[T.bg.id=e]+")");localStorage.setItem("bgId",e)});F.find("li").eq(T.bg.id).addClass("current")}L.toggleClass("current")}function V(){var t="";T.bg.list.forEach(function(i,e){t+='<li data-id="'+e+'"><a><img src="'+i+'"/></a></li>'});return t}I.find(".playConfig_"+T.config.playType).addClass("current");i.css("background-image","url("+T.bg.list[T.bg.id]+")");window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;A().done(function(t){T.songList=t.list}).then(_);t.on("resize",j);h.on("click","li",function(){var t=$(this),i=t.data("id");U(true);t.addClass("current").siblings().removeClass("current");B(i)});C.on("click","li",function(){var t=$(this),i=t.data("time");if(T.audio.paused||i===undefined){return false}if(T.audio.stop){B(T.currentID)}T.audio.currentTime=i/1e3});I.on("click","a",function(){var t=$(this),i=t.data("type");localStorage.setItem("playType",T.config.playType=i);t.addClass("current").siblings().removeClass("current")});$(document).on("keydown",function(t){switch(t.which){case 13:T.audio.currentTime=0;t.preventDefault();break;case 32:U();t.preventDefault();break;case 37:K();t.preventDefault();break;case 39:O();t.preventDefault();break;case 38:var i=T.audio.volume+.1;if(i>1){i=1}T.audio.volume=i;t.preventDefault();break;case 40:var i=T.audio.volume-.1;if(i<0){i=0}T.audio.volume=i;t.preventDefault();break}}).on("click",function(){L.removeClass("current")});L.on("click",function(t){t.stopPropagation()});c.on("click",U);o.on("click",U);b.on("click",J);s.on("click",K);l.on("click",O);k.on("click",Q);if(typeof define==="function"&&define.amd){define("player",[],function(){return T})}});